---
title: "Sibling facilitation"
author: "Ivan Bizberg"
date: "9/30/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.height = 10, fig.width = 15)
```

## libraries
```{r, message=FALSE}
library(tidyverse)
library(lubridate)
library(Greg)
library(broom)

library(performance)
library(DHARMa)

library(survival)
library(survminer)
library(coxme)
library(lme4)
library(glmmTMB)
library(effects)
library(ghibli)
library(ggthemes)
library(magrittr)
library(ggeffects)
```

```{r}
path = "Conducta"
source(str_glue("C:/Users/{path}/Dropbox/PHD/Custom functions/Censoring.R"))
```

## Import data    
```{r}
RawMother <- read.csv(str_glue("C:/Users/{path}/Dropbox/PHD/DATA/Csv/RawData4.5.csv"),sep =",",
                    header = T, stringsAsFactors = F)
```

## Add environemental conditions for fledged chick A

```{r}
ClimSMI <- read_csv(str_glue("C:/Users/{path}/Dropbox/PHD/Git/Climwin_BodyconditionA/FinalRefittedDATABodyCond_1.csv"))
ClimSMI_A <- ClimSMI %>% select(WORKYEAR, NIDO, RefittedChl, RefittedSST)

ClimM <- read_csv(str_glue("C:/Users/{path}/Dropbox/PHD/Git/Climwin_MassA/FinalRefittedDATABodyCond_1.csv"))
ClimM_A <- ClimM %>% select(ANILLO, WORKYEAR, NIDO, RefittedChl, RefittedSST, RefittedAreaRain)

Mother <- RawMother %>% left_join(ClimM_A, by = c("WORKYEAR", "NIDO"))
```



## Create base data for survival analisis
```{r}
RefMother <- Mother %>% 
  filter(!SEMANIPULO == "t") %>% 
  filter(!Nest_OrderFemale %in% c(2,3)) %>% 
  filter(!(!is.na(CONLLEGADA) & Eclos_Arrival < 21)) %>% # only use nest where laying date was after first monitoring or at least 3 weeks before arrival
  filter(!LastAge1 %in% c(-50 : 6)) %>% # Explore only nest survival between 5 days old to +
  Censoring(., 60)
# True_Singleton <- RefMother %>%
#   filter(PUESTA == 1 & NIDADA == 1) %>% 
#   mutate(SibPresence = "True_Singleton")

False_Singleton <- RefMother %>%
  filter(PUESTA == 2) %>%
  filter(DESTHUEVO1 %in% c("e")) %>% #Huevos depredados como cria aqui las dos crias eclosionaron
  filter((DESTHUEVO2 %in% c("e") & MURIO2 %in% c("t") & LastAge2 %in% c(0:5) & SENCONTRO2 %in% c("f")) | (DESTHUEVO2 %in% c("c"))) %>% 
  mutate(SibPresence = "0") %>% 
  mutate(Fledge = ifelse (MURIO1 == "f", 1, 0))
  
Siblings <- RefMother %>% 
  filter(PUESTA == 2 & NIDADA == 2) %>% 
  filter(!FECHFINAL1 < ESTECLOS2) %>% # filter only nest with cohabitation
  filter(!(MURIO2 %in% c("t") & LastAge2 %in% c(0:5))) %>% 
  # filter(!(MURIO2 == "f")) %>% 
  mutate(SibPresence = "1") %>% 
  mutate(Fledge = ifelse (MURIO1 == "f", 1, 0))

Facilitation <- bind_rows(#True_Singleton, 
  False_Singleton, Siblings) %>% 
  select(WORKYEAR, NIDO, PROPORTIONALRANK,
         SibPresence, Fledge,
         Death601, Time601,
         # CoupleExpLocal,
         # RealMotherAge, CONFIRMHEMB, ANILLOHEMB,
         # RealFatherAge,CONFIRMMACH,ANILLOMACH,
         ) %>%  
  # filter(CONFIRMHEMB == "t" & !ANILLOHEMB == "SA") %>%
  # filter(CONFIRMMACH == "t" & !ANILLOMACH == "SA") %>%  
  mutate(across(c(where(is.numeric), -Fledge, -WORKYEAR, -Death601, -Time601), arm::rescale)) %>% 
  mutate(across(c(where(is.character)), as.factor)) %>% 
  drop_na() %>% glimpse()

Facilitation %>% count(SibPresence)
```

### Data for survival analisis counting form
```{r}
DataCountingProcess = Facilitation %>% 
  mutate(across(c(Death601), as.character)) %>% # Step needed for greg package
  timeSplitter(by = 3, 
               event_var = "Death601",
               time_var = "Time601") %>% 
  mutate(Death = factor(Death601,
                        levels = 0:1,
                        labels = c("Alive", "Death"))) %>% 
  mutate(across(c(Death601), as.character)) %>% 
  mutate(across(c(Death601), as.numeric)) 
```



## Analysis nest survival

It's not interesting because the chick that lived with a brother live by default longer analyze from 5 days to age of death 

Cox model
```{r}
CoxData <- DataCountingProcess %>% select(Start_time, Stop_time, Death601, SibPresence, PROPORTIONALRANK, 
                                          # RealMotherAge, CoupleExpLocal, 
                                          WORKYEAR) %>% 
  mutate(across(c(PROPORTIONALRANK, #RealMotherAge, CoupleExpLocal
                  ), arm::rescale)) %>% 
  filter(!Start_time %in% c(0, 1)) %>% 
  mutate(across(c(SibPresence), as.factor)) %>% #filter(!SibPresence %in% c("Siblings", "False_Singleton", "True_Singleton")) %>%
  glimpse() 
Cox <- coxme(Surv(Start_time, Stop_time, Death601) ~ SibPresence +
               PROPORTIONALRANK +
               # RealMotherAge +
               # I(RealMotherAge^2) +
               # CoupleExpLocal + 
               (1|WORKYEAR),
             data = CoxData)

summary(Cox)
```
## Cox plot
```{r, eval=FALSE}
Cox <- coxph(Surv(Start_time, Stop_time, Death601) ~ strata(SibPresence) +
               PROPORTIONALRANK +
               # RealMotherAge +
               # I(RealMotherAge^2) +
               # CoupleExpLocal + 
               frailty(WORKYEAR),
             data = CoxData)

ggsurv <- ggsurvplot(survfit(Cox), data = CoxData, conf.int = T, palette = "Dark2", 
           censor = FALSE) #, legend.labs = c('Chick A from reduced clutch/brood of 3', 'Chick A from clutch of 3 (only A hatched)'))

predictions <- ggsurv$data.survplot

predictions %>% 
  ggplot(aes(time, surv, color = strata)) +
  geom_step(size = 0.5, alpha = 0.8) +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = strata), alpha = 0.4) +
  scale_x_continuous(n.breaks = 60) +
  theme_survminer() +
  theme(legend.position = c(0.6, 0.8))+
  xlab('Age (days)') +
  ylab('Survival probability') +
  scale_colour_ghibli_d("LaputaMedium", direction = -1) +
  scale_fill_ghibli_d("LaputaMedium", direction = -1, labels = c("Chick A from depredated nest",
                                                                 "Chick A from no depredated nest")) +
  guides(color = F, fill = guide_legend(title = "SibPresence"))
```

## Filter chicks of interest for mass analysis 
```{r}
RefMother <- Mother %>% 
  filter(!SEMANIPULO == "t") %>% 
  filter(!Nest_OrderFemale %in% c(2,3)) %>% 
  filter(!(!is.na(CONLLEGADA) & Eclos_Arrival < 21)) %>% # only use nest where laying date was after first monitoring or at least 3 weeks before arrival
  filter(!LastAge1 %in% c(-50 : 65)) %>% 
  Censoring(., 60)
# True_Singleton <- RefMother %>%
#   filter(PUESTA == 1 & NIDADA == 1) %>% 
#   mutate(SibPresence = "True_Singleton")

False_Singleton <- RefMother %>%
  filter(PUESTA == 2) %>%
  filter(DESTHUEVO1 %in% c("e")) %>% #Huevos depredados como cria aqui las dos crias eclosionaron
  filter((DESTHUEVO2 %in% c("e") & MURIO2 %in% c("t") & LastAge2 %in% c(0:5) & SENCONTRO2 %in% c("f")) | (DESTHUEVO2 %in% c("c"))) %>% 
  mutate(SibPresence = "0") %>% 
  mutate(Fledge = ifelse (MURIO1 == "f", 1, 0))
  
Siblings <- RefMother %>% 
  filter(PUESTA == 2 & NIDADA == 2) %>% 
  filter(!FECHFINAL1 < ESTECLOS2) %>% # filter only nest with cohabitation
  filter(!(MURIO2 %in% c("t") & LastAge2 %in% c(0:5))) %>% 
  # filter(!(MURIO2 == "f")) %>% 
  mutate(SibPresence = "1") %>% 
  mutate(Fledge = ifelse (MURIO1 == "f", 1, 0))
```


## Data for mass analisis
```{r}
Facilitation <- bind_rows(#True_Singleton, 
  False_Singleton, Siblings) %>% 
  select(WORKYEAR, NIDO, PROPORTIONALRANK,
         SibPresence, Fledge,
         BodyCondSMI1, PESO701, ULNA701,
         RefittedChl,
         RefittedSST,
         RefittedAreaRain,
         Death601, Time601,
         # CoupleExpLocal,
         # RealMotherAge, CONFIRMHEMB, ANILLOHEMB,
         # RealFatherAge,CONFIRMMACH,ANILLOMACH,
         ) %>%  
  # filter(CONFIRMHEMB == "t" & !ANILLOHEMB == "SA") %>%
  # filter(CONFIRMMACH == "t" & !ANILLOMACH == "SA") %>%  
  mutate(across(c(where(is.numeric), -BodyCondSMI1, -PESO701, -Fledge, -WORKYEAR, -Death601, -Time601), arm::rescale)) %>% 
  mutate(across(c(where(is.character)), as.factor)) %>% 
  drop_na() %>% glimpse()

Facilitation %>% count(SibPresence)

# Remove outliers
outliers=boxplot(Facilitation$BodyCondSMI1,range = 3)$out
DATABodyout=Facilitation[-which(Facilitation$BodyCondSMI1 %in% outliers),]#Remove outliers
hist(DATABodyout$BodyCondSMI1)
```

## Analysis mass LMER
```{r}
DATABodyout %<>% mutate(SibPresence = fct_relevel(SibPresence, "1", after = 3L))
levels(DATABodyout$SibPresence)
DATABodyout %>% glimpse()

Bestcond=lmer(BodyCondSMI1 ~ SibPresence + PROPORTIONALRANK + # Interaction effect with SST and Chl
                RefittedChl +
                I(RefittedChl^2) +
                RefittedSST +
                I(RefittedSST^2) +
                RefittedAreaRain +
                I(RefittedAreaRain^2) +
                SibPresence:RefittedSST+
                # ULNA701 +
                # CoupleExpLocal +
                # RealMotherAge +
                # I(RealMotherAge^2) +
                (1|WORKYEAR), #+ (1|ANILLOHEMB),
              REML= FALSE, data = DATABodyout)
sjPlot::tab_model(Bestcond)

Summary_M <- summary(Bestcond) 
CI_M <- confint(Bestcond) %>% as.data.frame() %>% rownames_to_column("Terms") %>% slice(-1, -2)
FixCoef_M <- Summary_M$coefficients %>% as.data.frame() %>% rownames_to_column("Terms")
RandCoef_M <- Summary_M$varcor %>% as.data.frame() %>% select(-var1, -var2) %>% rename(Terms = grp)
CoefTable_M <- CI_M %>% left_join(FixCoef_M, by = "Terms") %>% bind_rows(RandCoef_M)
write_csv(CoefTable_M, "Mass_Results.csv")


levels(Facilitation$SibPresence)
emmeans::lsmeans(Bestcond, pairwise ~ SibPresence, adjust = "tukey")
```
## Plot
```{r}
plot(ggeffect(Bestcond,type = "response",c("RefittedChl","SibPresence")))
ef <- effect("SibPresence:RefittedChl", Bestcond)
x <- as.data.frame(ef)
summary(x)
ggplot(x, aes(SibPresence, fit, color = SibPresence)) + geom_line() +
  geom_smooth(aes(ymin=lower, ymax=fit+se, fill = SibPresence), stat = "identity", alpha = 0.3) +
  theme_fivethirtyeight() +
  theme(axis.title = element_text(),
        plot.caption = element_text(size = 15, hjust = 0),
        plot.background = element_rect(fill = "white"),
        panel.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white")) +
  scale_x_continuous(n.breaks = 10) +
  scale_y_continuous(n.breaks = 10) +
  scale_fill_manual(values =  c("#a60019" ,"#009dab")) +
  scale_color_manual(values = c("#a60019" ,"#009dab")) +
  labs(x = "Cohabitation Time", y = "Body Condition",
       caption = "Graph of the body condition in function of cohabitation time
when brood reduction occurred")

ggsave(filename = "C:/Users/ivan/Dropbox/PHD/Plots/rplot.png", width = 9, height = 6)
```



The only significatif term is proportional rank. 
Mother, couple experiance and layasyncrony does't have any effect
There is no significative interaction between PropRank/SST/Chl and SibPresence
There is no difference between singletons and siblings in body condition/weight at 70 days

### Check diagnostic
```{r}
#Check Vif
check_collinearity(Bestcond) # OK

## Attacin from Woestmann
## Linearity
plot(resid(Bestcond),fitted(Bestcond))
## Homogeneity
plot(Bestcond)
## Normality
qqnorm(residuals(Bestcond))
## Outlier
library(plotly)
ggplotly(plot(hatvalues(Bestcond)~residuals(Bestcond)))
```






# Long term data

## Import adult data and add it
```{r}
DATA_Adults <- read.csv("DATA_Adult.csv")

LongTerm_Facilitation <- bind_rows(#True_Singleton, 
  False_Singleton, Siblings) %>% 
  select(WORKYEAR, NIDO, PROPORTIONALRANK,
         SibPresence, ANILLO1,
         # RefittedChl, RefittedSST
         # CoupleExpLocal
         # RealMotherAge, CONFIRMHEMB, ANILLOHEMB
         # RealFatherAge,CONFIRMMACH,ANILLOMACH
         ) %>%  
  # filter(CONFIRMHEMB == "t" & !ANILLOHEMB == "SA") %>%  
  # filter(CONFIRMMACH == "t" & !ANILLOMACH == "SA") %>%  
  mutate(across(c(where(is.numeric)), arm::rescale)) %>% 
  mutate(across(c(where(is.character)), as.factor)) %>% 
  drop_na() %>% glimpse()


LongTerm_Facil <- inner_join(LongTerm_Facilitation, DATA_Adults, by = c("ANILLO1" = "IDAdult")) %>% drop_na() %>% 
  mutate(Sex = as.factor(Sex)) %>% glimpse()
LongTerm_Facil %>% count(SibPresence)    
```

## Check sample size and distributions
```{r}
LongTerm_Facil %>% names()
LongTerm_Facil %>% count(SibPresence)

hist(LongTerm_Facil$Fechpuestamean) # normal distribution
hist(LongTerm_Facil$Clutchsum) # trunquated poisson distribution
hist(LongTerm_Facil$Fledgesum) # poisson distribution
```
 

# Average laying timing during the first 6 years 
```{r}
Laying_date <- lmer(Fechpuestamean ~ SibPresence +
                      PROPORTIONALRANK +
                      # RefittedChl + RefittedSST +
                      # RefittedChl : SibPresence +
                      # Sex : SibPresence +
                      Sex + 
                      (1|WORKYEAR),
                    data = LongTerm_Facil)

sjPlot::tab_model(Laying_date)

Summary_L <- summary(Laying_date) 
CI_L <- confint(Laying_date) %>% as.data.frame() %>% rownames_to_column("Terms") %>% slice(-1, -2) 
FixCoef_L <- Summary_L$coefficients %>% as.data.frame() %>% rownames_to_column("Terms")
RandCoef_L <- Summary_L$varcor %>% as.data.frame() %>% select(-var1, -var2) %>% rename(Terms = grp)
CoefTable_L <- CI_L %>% left_join(FixCoef_L, by = "Terms") %>% bind_rows(RandCoef_L)
write_csv(CoefTable_L, "Laying_Results.csv")


check_collinearity(Laying_date) 
```


# Eggs produced during the first 6 years 

```{r}
Egg_produced <- glmmTMB(Clutchsum ~ SibPresence +
                          PROPORTIONALRANK +
                          # RefittedChl + RefittedSST +
                          Sex + 
                          (1|WORKYEAR),
                        family = "truncated_poisson"(link = "log"),
                        REML = F, 
                        data = LongTerm_Facil)

check_collinearity(Egg_produced) 

Summary_E <- summary(Egg_produced) 
CI_E <- confint(Egg_produced) %>% as.data.frame() %>% rownames_to_column("Terms") %>% select(-Estimate) %>% 
  mutate(Terms = str_remove(Terms, "cond."), Terms = str_remove(Terms, ".Std.Dev.\\(Intercept\\)")) 
FixCoef_E <- Summary_E$coefficients$cond %>% as.data.frame() %>% rownames_to_column("Terms")
RandCoef_E <- Summary_E$varcor$cond %>% .[1] %>% as.data.frame() %>% rename(Variance  = X.Intercept.) %>% 
  mutate(Std.Dev. = sqrt(Variance)) %>% mutate(Terms = "WORKYEAR", .before = Variance)
CoefTable_E <- FixCoef_E %>% bind_rows(RandCoef_E) %>% left_join(CI_E, by = "Terms")
write_csv(CoefTable_E, "Eggs_Results.csv")
```

# Fledglings produced during the first 6 years (5 years?)

```{r}
Fledg_produced <- glmmTMB(Fledgesum ~ SibPresence +
                          PROPORTIONALRANK +
                          # RefittedChl + RefittedSST +
                          Sex + 
                          (1|WORKYEAR),
                        family = poisson(link = "log"),
                        ziformula = ~0,
                        REML = F, 
                        data = LongTerm_Facil)

check_collinearity(Fledg_produced) 


Summary_F <- summary(Fledg_produced) 
CI_F <- confint(Fledg_produced) %>% as.data.frame() %>% rownames_to_column("Terms") %>% select(-Estimate) %>% 
  mutate(Terms = str_remove(Terms, "cond."), Terms = str_remove(Terms, ".Std.Dev.\\(Intercept\\)")) 
FixCoef_F <- Summary_F$coefficients$cond %>% as.data.frame() %>% rownames_to_column("Terms")
RandCoef_F <- Summary_F$varcor$cond %>% .[1] %>% as.data.frame() %>% rename(Variance  = X.Intercept.) %>% 
  mutate(Std.Dev. = sqrt(Variance)) %>% mutate(Terms = "WORKYEAR", .before = Variance)
CoefTable_F <- FixCoef_F %>% bind_rows(RandCoef_F) %>% left_join(CI_F, by = "Terms")
write_csv(CoefTable_F, "Fledglings_Results.csv")

```

# Recruits produced during the first 6 years 
```{r}

LongTerm_Facil_rec <- LongTerm_Facil %>% filter(WORKYEAR < 2012)
LongTerm_Facil_rec %>% count("SibPresence")
hist(LongTerm_Facil_rec$sum_recruits)

Recru_produced <- glmmTMB(sum_recruits ~ SibPresence +
                          PROPORTIONALRANK +
                          # RefittedChl + RefittedSST +
                          Sex + 
                          (1|WORKYEAR),
                        family = poisson(link = "log"),
                        ziformula = ~0,
                        REML = F, 
                        data = LongTerm_Facil_rec)


check_collinearity(Recru_produced) 


Summary_R <- summary(Recru_produced) 
CI_R <- confint(Recru_produced) %>% as.data.frame() %>% rownames_to_column("Terms") %>% select(-Estimate) %>% 
  mutate(Terms = str_remove(Terms, "cond."), Terms = str_remove(Terms, ".Std.Dev.\\(Intercept\\)")) 
FixCoef_R <- Summary_R$coefficients$cond %>% as.data.frame() %>% rownames_to_column("Terms")
RandCoef_R <- Summary_R$varcor$cond %>% .[1] %>% as.data.frame() %>% rename(Variance  = X.Intercept.) %>% 
  mutate(Std.Dev. = sqrt(Variance)) %>% mutate(Terms = "WORKYEAR", .before = Variance)
CoefTable_R <- FixCoef_R %>% bind_rows(RandCoef_R) %>% left_join(CI_R, by = "Terms")
write_csv(CoefTable_R, "Recruits_Results.csv")
```




```{r}
# Diagnostics
res = simulateResiduals(Fledg_produced)
plot(res)
testDispersion(res)
testUniformity(res)
testOutliers(res)
testQuantiles(res)
testZeroInflation(res)
```

































# Recrutement probability 

# Data
```{r, eval=FALSE}
Facilitation <- bind_rows(True_Singleton, False_Singleton, Siblings) %>% 
  filter(MURIO1 == "f") %>%
  select(WORKYEAR, NIDO, PROPORTIONALRANK,
         SibPresence, MURIO1,
         BodyCondSMI1, ULNA701, PESO701,
         Recruit1,
         RefittedChl, RefittedSST,
         # CoupleExpLocal,
         # RealMotherAge, CONFIRMHEMB, ANILLOHEMB,
         # AGEMACH,CONFIRMMACH,ANILLOMACH
         ) %>% 
  mutate(across(c(where(is.numeric), -Recruit1), arm::rescale)) %>% 
  mutate(across(c(where(is.character)), as.factor)) %>% 
  drop_na() %>% glimpse()

Facilitation %>% count(SibPresence)

```

## GLMER
```{r, eval=FALSE}

Facilitation %<>% mutate(SibPresence = fct_relevel(SibPresence, "True_Singleton", after = 0L)) 
levels(Facilitation$SibPresence)

Bestsurvival=glmmTMB(Recruit1 ~  SibPresence + BodyCondSMI1 +
                       PROPORTIONALRANK + 
                       RefittedChl + 
                       RefittedSST +
                       RefittedSST : SibPresence + 
                       #AGEHEMB +
                       # CoupleExpLocal +
                       # SibPresence : SSTYear+
                       (1|WORKYEAR),
                     family = binomial(link="logit"), REML = FALSE, ziformula = ~ 0,
                     data = Facilitation) #cloglog winer vs logit / z0 winner vs Z1

summary(Bestsurvival)
emmeans::lsmeans(Bestsurvival, pairwise ~ SibPresence, adjust = "tukey")
```

### Plot GLMER
```{r, eval=FALSE}
plot(allEffects(Bestsurvival))
```
Proportional rank and SST have an effect on recruit probabilities. Interestingly it seems that SST has a stronger negatif effect on chicks A that shared the nest with a sibling than true singleton. Chl has no effect in recruitment.


























### Select singletons broods and brood reduced broods
```{r, eval=FALSE}
source(str_glue("C:/Users/{path}/Dropbox/PHD/Custom functions/Censoring.R"))
# source(str_glue("C:/Users/{path}/Dropbox/PHD/Custom functions/sum_na.R"))


RefMother <- Mother %>% 
  filter(SEMANIPULO == "f") %>% 
  # filter(is.na(CONLLEGADA)) %>% 
  filter(!(!is.na(CONLLEGADA) & Eclos_Arrival < 21)) %>% # only use nest where laying date was after first monitoring or at least 3 weeks before arrival
  filter(!Nest_OrderFemale %in% c(2,3)) %>%
  Censoring(., 60) %>% 
  # filter(!(MURIO2 %in% c("t") & LastAge2 %in% c(0:5) & SENCONTRO2 %in% c("f"))) %>% # remove depredation
  # filter(!(MURIO1 %in% c("t") & LastAge1 %in% c(0:5) & SENCONTRO1 %in% c("f"))) %>% 
  mutate(across(c(FECHFINAL1), ymd))
```

##### For Chick A
```{r, eval=FALSE}
Singleton <- RefMother %>%
  # filter(!WORKYEAR < 2003) %>% # In case that we want to study chl effect (if we thinks sibling facilitation changes in function of resources availability)
  filter(PUESTA == 1 & NIDADA == 1) %>% 
  mutate(SibPresence = "True_Singleton")

False_Singleton <- RefMother %>%
  # filter(!WORKYEAR < 2003) %>% # In case that we want to study chl effect (if we thinks sibling facilitation changes in function of resources availability)
  filter(PUESTA == 2 & NIDADA == 1) %>% 
  mutate(SibPresence = "False_Singleton")
  
Siblings <- RefMother %>% 
  # filter(!WORKYEAR < 2003) %>% 
  filter(PUESTA == 2 & NIDADA == 2) %>% 
  filter(!FECHFINAL1 < ESTECLOS2) %>% # filter only nest with cohabitation
  filter(xor(Death602 == 1, Death601 == 1)) %>% # keep only nest where B died or A died
  mutate(SibPresence = "Siblings") 

Triblings <- RefMother %>%
  # filter(!WORKYEAR < 2003) %>%
  filter(PUESTA == 3 & NIDADA == 3) %>%
  filter(FECHFINAL1 > ESTECLOS3) %>% # filter only nest with cohabitation
  # filter(Death602 == 1 & Death603 == 1) %>% # keep only nest where B and C died
  mutate(SibPresence = "Triblings") # Chick A from reduced clutch/brood of 3

TriblingsA <- RefMother %>%
  # filter(!WORKYEAR < 2003) %>%
  filter(PUESTA == 3 & NIDADA == 1) %>%
  filter(DESTHUEVO1 == "e") %>% # filter only nest with cohabitation
  mutate(SibPresence = "TriblingsA") # Chick A from clutch of 3 (only A hatched)


Facilitation <- bind_rows(Singleton, False_Singleton, 
                          Triblings, TriblingsA,
                          Siblings) 

DataCountingProcess = Facilitation %>% 
  filter(across(c(Death601, Time601), ~ !is.na(.))) %>% 
  mutate(across(c(Death601), as.character)) %>% 
  # Step needed for greg package
  timeSplitter(by = 3, 
               event_var = "Death601",
               time_var = "Time601",
               event_start_SibPresence = "0") %>% 
  mutate(Death = factor(Death601,
                        levels = 0:1,
                        labels = c("Alive", "Death"))) %>% 
  mutate(across(c(Death601), as.character)) %>% 
  mutate(across(c(Death601), as.numeric)) 

```

#### For chick B
```{r, eval=FALSE}
Triblings_ForB <- RefMother %>%
  # filter(!WORKYEAR < 2003) %>%
  filter(PUESTA == 3 & NIDADA == 3) %>%
  filter(FECHFINAL2 > ESTECLOS3) %>% # filter only nest with cohabitation
  filter(Death601 == 0 & Death603 == 1) %>% # keep only nest where B and C died
  mutate(SibPresence = "Triblings") # Chick B from reduced clutch/brood of 3

TriblingsB_ForB <- RefMother %>%
  # filter(!WORKYEAR < 2003) %>%
  filter(PUESTA == 3 & NIDADA == 2) %>%
  filter(Death601 == 0 & DESTHUEVO3 != "e") %>% # filter only nest with cohabitation
  mutate(SibPresence = "TriblingsB") # Chick B from clutch of 3 (C didn't hatch)

SiblingsB <- RefMother %>% 
  # filter(!WORKYEAR < 2003) %>% 
  filter(PUESTA == 2 & NIDADA == 2) %>% 
  filter(Death601 == 0) %>% # keep only nest where B died
  mutate(SibPresence = "SiblingsB") 


FacilitationB <- bind_rows(Triblings_ForB, TriblingsB_ForB, 
                          SiblingsB)

DataCountingProcessB = FacilitationB %>% 
  filter(across(c(Death602, Time602), ~ !is.na(.))) %>% 
  mutate(across(c(Death602), as.character)) %>% 
  # Step needed for greg package
  timeSplitter(by = 3, 
               event_var = "Death602",
               time_var = "Time602",
               event_start_SibPresence = "0") %>% 
  mutate(Death = factor(Death602,
                        levels = 0:1,
                        labels = c("Alive", "Death"))) %>% 
  mutate(across(c(Death602), as.character)) %>% 
  mutate(across(c(Death602), as.numeric)) 

```
#### For Chick A
# Cox Model
```{r, eval=FALSE}
CoxData <- DataCountingProcess %>% select(Start_time, Stop_time, Death601, SibPresence, PROPORTIONALRANK, RealMotherAge,
                                          CoupleExpLocal, WORKYEAR) %>% 
  mutate(across(c(PROPORTIONALRANK, RealMotherAge, CoupleExpLocal), arm::rescale)) %>% 
  mutate(across(c(SibPresence), as.factor)) %>% #filter(!SibPresence %in% c("Siblings", "False_Singleton", "True_Singleton")) %>%
  glimpse() 
Cox <- coxph(Surv(Start_time, Stop_time, Death601) ~ strata(SibPresence) +
               PROPORTIONALRANK +
               RealMotherAge +
               I(RealMotherAge^2) +
               CoupleExpLocal + 
               frailty(WORKYEAR),
             data = CoxData)

summary(Cox)
```
## Cox plot

```{r, eval=FALSE}
ggsurv <- ggsurvplot(survfit(Cox), data = CoxData, conf.int = T, palette = "Dark2", 
           censor = FALSE) #, legend.labs = c('Chick A from reduced clutch/brood of 3', 'Chick A from clutch of 3 (only A hatched)'))

predictions <- ggsurv$data.survplot

predictions %>% 
  filter(!strata %in% c("Triblings", "TriblingsA")) %>%
  # filter(!strata %in% c("Siblings", "False_Singleton", "True_Singleton")) %>%
  ggplot(aes(time, surv, color = strata)) +
  geom_step(size = 0.5, alpha = 0.8) +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = strata), alpha = 0.4) +
  theme_survminer() +
  theme(legend.position = c(0.6, 0.8))+
  xlab('Age (days)') +
  ylab('Survival probability') +
  scale_colour_ghibli_d("LaputaMedium", direction = -1) +
  scale_fill_ghibli_d("LaputaMedium", direction = -1, labels = c("Chick A from clutch of 2 (only A hatched)",
                                                                 "Chick A from reduced clutch/brood of 2",
                                                                 "Chick A from clutch of 1")) +
  # scale_colour_ghibli_d("MononokeMedium", direction = 1) +
  # scale_fill_ghibli_d("MononokeMedium", direction = 1, labels = c("Chick A from clutch of 3",
  #                                                                 "Chick A from reduced clutch/brood of 3")) +
  guides(color = F, fill = guide_legend(title = "SibPresence"))

```
#### For Chick B
# Cox Model
```{r, eval=FALSE}
CoxData <- DataCountingProcessB %>% select(Start_time, Stop_time, Death602, SibPresence, PROPORTIONALRANK, RealMotherAge,
                                          CoupleExpLocal, WORKYEAR) %>% 
  mutate(across(c(PROPORTIONALRANK, RealMotherAge, CoupleExpLocal), arm::rescale)) %>% 
  mutate(across(c(SibPresence), as.factor)) %>% #filter(!SibPresence %in% c("Siblings", "False_Singleton", "True_Singleton")) %>%
  glimpse() 

Cox <- coxph(Surv(Start_time, Stop_time, Death602) ~ strata(SibPresence) +
               PROPORTIONALRANK +
               RealMotherAge +
               I(RealMotherAge^2) +
               CoupleExpLocal + 
               frailty(WORKYEAR),
             data = CoxData)

summary(Cox)
```
## Cox plot
```{r, eval=FALSE}
ggsurv <- ggsurvplot(survfit(Cox), data = CoxData, conf.int = T, palette = "Dark2", 
           censor = FALSE) #, legend.labs = c('Chick A from reduced clutch/brood of 3', 'Chick A from clutch of 3 (only A hatched)'))

predictions <- ggsurv$data.survplot

predictions %>% 
  ggplot(aes(time, surv, color = strata)) +
  geom_step(size = 0.5, alpha = 0.8) +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = strata), alpha = 0.4) +
  scale_x_continuous(n.breaks = 60) +
  theme_survminer() +
  theme(legend.position = c(0.6, 0.8))+
  xlab('Age (days)') +
  ylab('Survival probability') +
  scale_colour_ghibli_d("LaputaMedium", direction = -1) +
  scale_fill_ghibli_d("LaputaMedium", direction = -1, labels = c("Chick A from depredated nest",
                                                                 "Chick A from no depredated nest")) +
  guides(color = F, fill = guide_legend(title = "SibPresence"))
```


```{r, eval=FALSE}
New_data <- expand.grid(SibPresence = c("True_Singleton", "Siblings"), PROPORTIONALRANK = mean(CoxData$PROPORTIONALRANK, na.rm = T),
                        RealMotherAge = mean(CoxData$RealMotherAge, na.rm = T), 
                        CoupleExpLocal = mean(CoxData$CoupleExpLocal, na.rm = T),
                        Start_time = 1:60)
prs = predict(Cox, New_data,
              type = c("risk"), se.fit = T)
NDpred = New_data %>% mutate(pred = prs$fit) #%>% group_by(SibPresence, Start_time) %>% summarise(mean_pred = mean(pred, na.rm = T))
NDpred %>%
  # filter(ClimWSST == median(ClimWSST)) %>%
  # filter(HatchAsync == median(HatchAsync)) %>%
  # filter(PROPORTIONALRANK == median(PROPORTIONALRANK)) %>%
  # filter(WORKYEAR == 2017) %>%
  # arrange(ClimWRain_2) %>%
  ggplot(aes(Start_time ,pred), color = "SibPresence") + geom_point() #+ geom_smooth(method = "lm", formula = y ~ x, size = 1) +
  # geom_smooth(stat = "identity", aes(ymin = lo, ymax = up)) +
  # scale_x_continuous(n.breaks = 20, limits = c(22,28)) +
  # scale_y_continuous(labels = scales::comma, n.breaks = 20, limits = c(0.1,10)) +
  geom_hline(yintercept = 1, size = 1.1, color = "red", linetype = "dashed") +
  geom_vline(xintercept = 24.5, size = 0.5, color = "red", linetype = "dashed") +
  labs(y = "Hazard Ratio") +
  theme_fivethirtyeight() + theme(axis.title = element_text())
```


### Diagnostic
```{r, eval=FALSE}
# check_collinearity(Coxme)
rms::vif(Cox)
zph <- cox.zph(Cox) ; zph
ggcoxzph(zph) # For ploting

aa_fit <-aareg(Surv(Start_time, Stop_time, Death601) ~ SibPresence +
               PROPORTIONALRANK +
               RealMotherAge +
               CoupleExpLocal + 
               frailty(WORKYEAR),
             data = CoxData)

plot(aa_fit)

# autoplot(aa_fit)
```
```{r, eval=FALSE}
# Final Checking influential observations 

# type = "dfbeta" , type = "deviance"

ggcoxdiagnostics(Cox, type = , linear.predictions = TRUE)

ggcoxdiagnostics(Cox, type = "dfbeta",
                 linear.predictions = FALSE, ggtheme = theme_bw())

ggcoxdiagnostics(Cox, type = "deviance",
                 linear.predictions = FALSE, ggtheme = theme_bw()) # We see more negative values correspond to individual that "lived too long". Only problem with diagnostic

# Identify outliers 
library(coxrobust)
res_mart = resid(Cox,type="martingale") %>% stack()# martingale or deviance
res_mart %>% #dplyr::slice_max(values, n = 100) %>% 
  ggplot(aes(ind, values)) + geom_point()
```
