---
title: "Sibling facilitation"
author: "Ivan Bizberg"
date: "9/30/2020"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.height = 10, fig.width = 15)
options(scipen = 999)
```

## libraries
```{r, message=FALSE}
library(tidyverse)
library(tidymodels)
library(lubridate)
library(Greg)
library(broom)

library(performance)
library(DHARMa)

library(survival)
library(survminer)
library(coxme)
library(lme4)
library(glmmTMB)
library(effects)
library(ghibli)
library(ggthemes)
library(magrittr)
library(ggeffects)
```

# Prepare environement
```{r}
path = "Conducta"
source(str_glue("C:/Users/{path}/Dropbox/PHD/Custom functions/Censoring.R"))
source(str_glue("C:/Users/{path}/Dropbox/PHD/Custom functions/sum_na.R"))
```

## Import data    
```{r}
RawMother <- read.csv(str_glue("C:/Users/{path}/Dropbox/PHD/DATA/RawData4.5.csv"),sep =",",
                    header = T, stringsAsFactors = F)
```

# Survival analysis 
## Create base data for survival analisis
```{r}
RefMother <- RawMother %>% 
  filter(!SEMANIPULO == "t") %>% # Remove manipulated nests
  filter(!Nest_OrderFemale %in% c(2,3)) %>% # Remove re-nest
  filter(!(!is.na(CONLLEGADA) & Arrival_date > ESTECLOS1)) %>% # Remove nest where chicks hatched before nest monitoring because we don't know the brood size and what chick is which.
  # filter(!(!is.na(CONLLEGADA) & Eclos_Arrival < 40)) %>% # only use nest where laying date was after first monitoring or at least 3 weeks before arrival (first monitoring) Maybe this is not needed because low proba to lay clutches of 3 and low proba of been depredated by gulls
  filter(!LastAge1 %in% c(-50 : 5)) %>% # Explore only nest survival between 6 days old to +
  Censoring(., 60) #%>% 
  # drop_na(ECLOSION1, ECLOSION2) %>% 
  # filter(ECLOSION1 < ECLOSION2) # We know how hatch first how hatch later
  
  
False_Singleton <- RefMother %>%
  filter(PUESTA == 2) %>%
  filter(DESTHUEVO1 %in% c("e")) %>% #Huevos depredados como cria aqui las dos crias eclosionaron
  filter((DESTHUEVO2 %in% c("e") & MURIO2 %in% c("t") & LastAge2 %in% c(0:5) & SENCONTRO2 %in% c("f")) | (DESTHUEVO2 %in% c("c"))) %>% 
  mutate(SibPresence = "0") %>% 
  mutate(Fledge = ifelse (MURIO1 == "f", 1, 0))
  
Siblings <- RefMother %>% 
  filter(PUESTA == 2 & NIDADA == 2) %>% 
  filter(!FECHFINAL1 < ESTECLOS2) %>% # filter only nest with cohabitation (data base errors)
  filter(!(MURIO2 %in% c("t") & LastAge2 %in% c(0:5))) %>% 
  # filter(!(MURIO2 == "f")) %>% 
  mutate(SibPresence = "1") %>% 
  mutate(Fledge = ifelse (MURIO1 == "f", 1, 0))

Facilitation <- bind_rows(False_Singleton, Siblings) %>% 
  mutate(across(c(FECHFINAL1, ESTECLOS1), ymd)) %>% 
  mutate(FinalDate = ESTECLOS1 + Time601) %>% 
  select(WORKYEAR, NIDO, PROPORTIONALRANK,
         SibPresence, Fledge,
         Death601, Time601,
         ESTECLOS1, FinalDate, FECHFINAL1,
         CoupleExpLocal,
         RealMotherAge, CONFIRMHEMB, ANILLOHEMB,
         RealFatherAge,CONFIRMMACH,ANILLOMACH,
         EstHatchAsynchro12_,
         ) %>%  
  # filter(CONFIRMHEMB == "t" & !ANILLOHEMB == "SA") %>%
  # filter(CONFIRMMACH == "t" & !ANILLOMACH == "SA") %>%  
  mutate(across(c(where(is.numeric), -Fledge, -WORKYEAR, -Death601, -Time601), arm::rescale)) %>% 
  mutate(across(c(where(is.character), WORKYEAR), as.factor)) 

```

## Import environemental conditions to survival data
```{r}
# Add climwin windows for this data 

ClimData = read.csv(str_glue("C:/Users/{path}/Dropbox/PHD/DATA/ClimateVariables4.0.csv"), sep = ",", 
                    header = T,stringsAsFactors = F) %>%
  rename(Date = time) %>% mutate(Date = ymd(Date)) %>% arrange(Date) %>% 
  mutate(SST = as.numeric(SST)) %>% 
  glimpse()
```
### Data impute missing climatic data 

Using similar tecnique as climwin package
```{r}

Clim_imput = ClimData %>% arrange(Date) %>% select(Date , SST, Chl, Area_Rain) %>%
  recipe(~ .) %>% 
  step_rollimpute(all_of(c("SST", "Chl", "Area_Rain")), window = 15, statistic = mean) %>%
  prep() %>% bake(., new_data = NULL)

# Check imputation
colSums(is.na(Clim_imput))
```



### Create data for survival analisis counting form
```{r}
DataCountingProcess = Facilitation %>% 
  drop_na(Death601) %>% 
  mutate(across(c(everything(), -Time601), as.character)) %>% # Step needed for greg package
  timeSplitter(by = 3, 
               event_var = "Death601",
               time_var = "Time601") %>% 
  mutate(Death = factor(Death601,
                        levels = 0:1,
                        labels = c("Alive", "Death"))) %>% 
  mutate(across(c(Death601), as.character)) %>% 
  mutate(across(c(PROPORTIONALRANK, Death601, Fledge), as.numeric)) %>% 
  mutate(across(c(ESTECLOS1, FinalDate, FECHFINAL1), ymd)) %>% 
  mutate(Date_Start_time = ESTECLOS1 + Start_time, Date_Stop_time = ESTECLOS1 + (Stop_time - 1)) %>% glimpse()

# Add climdata to counting data
ClimCount <- DataCountingProcess %>% 
  rowwise() %>% 
  mutate(listChl = list(ClimData$Chl[ClimData$Date %within% interval(Date_Start_time, Date_Stop_time)])) %>%
  mutate(listSST = list(ClimData$SST[ClimData$Date %within% interval(Date_Start_time, Date_Stop_time)])) %>% 
  mutate(listArea_rain = list(ClimData$Area_Rain[ClimData$Date %within% interval(Date_Start_time, Date_Stop_time)])) %>% 
      ungroup() %>% 
  mutate(
    Chl = map_dbl(listChl, mean, na.rm = T),
    SST = map_dbl(listSST, mean, na.rm = T),
    Area_rain = map_dbl(listArea_rain, mean, na.rm = T))

write.csv(ClimCount %>% select(-contains("list")), "ClimDatasurvival_facilitation.csv")
```

## Prepare data for analysis
```{r}
ClimCounts <- read_csv("ClimDatasurvival_facilitation.csv")


# Fix some remaining na that cause problems to cox model after imputation
Nest_rmChl <- ClimCounts %>% filter(Death601 == 1 & (is.na(SST) | is.na(Chl))) %>% .$NIDO # If i don't want to include Chl in analysis
Nest_rm <- ClimCounts %>% filter(Death601 == 1 & (is.na(SST))) %>% .$NIDO

CoxData <- ClimCounts %>% mutate(across(c(Chl, SST, Area_rain), arm::rescale)) %>% 
  filter(!NIDO %in% Nest_rmChl)
  
CoxData_rmChl <- ClimCounts %>% mutate(across(c(Chl, SST, Area_rain), arm::rescale)) %>% 
  filter(!NIDO %in% Nest_rm) %>% 
  select(-Chl) 



colSums(is.na(ClimCount_na))





write_csv(CoxData, "Datasurvival_facilitation.csv")
write_csv(CoxData_rmChl, "Datasurvival_facilitationChlrm.csv")
```


## Analysis nest survival Select covariates

It's not interesting because the chick that lived with a brother live by default longer. So analyze from 5 days to age of death? No because when chick A has 5 days old chicks B can have 0 years old.

```{r}
Datasurvival_facilitation <- read_csv("Datasurvival_facilitation.csv")
Datasurvival_facilitation <- read_csv("Datasurvival_facilitationChlrm.csv")



Datasurvival <- Datasurvival_facilitation %>% 
  mutate(across(c(WORKYEAR, SibPresence), as.character)) %>% 
  select(Start_time, Stop_time, Death601, PROPORTIONALRANK, SST, Area_rain,
         # RealMotherAge, ANILLOHEMB, CONFIRMHEMB,
         RealFatherAge, ANILLOMACH, CONFIRMMACH,
         # CoupleExpLocal,
         Chl,
         NIDO, WORKYEAR, SibPresence) %>% 
  # filter(CONFIRMHEMB == T, !ANILLOHEMB == "SA") %>%
  filter(CONFIRMMACH == T, !ANILLOMACH == "SA") %>%
  drop_na() %>% 
  glimpse()

# Sample size (save)
SampleSize <- Datasurvival %>% count(NIDO, SibPresence) %>% count(SibPresence); SampleSize
write_csv(SampleSize, "SampleSize_Facilitation.csv")
```


## Cox model
```{r}
Datasurvival %<>% mutate(SibPresence = fct_relevel(SibPresence, "0", after = 3L))
levels(Datasurvival$SibPresence)

Cox <- coxme(Surv(Start_time, Stop_time, Death601) ~ SibPresence +
               PROPORTIONALRANK +
               # SibPresence : Chl + # No Sign
               SibPresence : SST + # SIgn  #(SST +  I(SST^2)) + #NO Sign
               # SibPresence : PROPORTIONALRANK + # No Sign
               Chl +
               I(Chl^2) +
               SST + 
               I(SST^2) +
               Area_rain +
               I(Area_rain^2) +
               RealFatherAge +
               I(RealFatherAge^2) +
               # CoupleExpLocal +
               (1|WORKYEAR) + (1|NIDO),
             data = Datasurvival)
summary(Cox)

saveRDS(Cox, file = "Cox_Facilitation_Mal.rds")
```


Chl don't have a sign effect on chick A survival neither the interaction
SST have an interaction effect with SibPresence. We conclude that the SST effect is stronger in chicks with siblings 


Even if this analysis is very similar to the previous analysis (sibling insurance) this one is closer to the hypothesis tested. In both analysis we found that the death of the marginal chick in a brood of two increased chick A death probability. However this could be related to the fact that if the marginal chick died due to bad environmental condition that also affect chick A or that parents that lost B chick are of bad quality and unable to fledged their offspring. In order to confirm that the increased death proba isn't related to environnemental quality we compare chick were the death has caused by a "random" factor (snake depredation)

## Cox plot
```{r, eval=FALSE}
Coxph <- coxph(Surv(Start_time, Stop_time, Death601) ~ strata(SibPresence) +
               PROPORTIONALRANK +
               # SibPresence : Chl + # No Sign
               # SibPresence : SST +
               # SibPresence : PROPORTIONALRANK + # No Sign
               Chl +
               I(Chl^2) +
               SST + 
               I(SST^2) +
               Area_rain +
               I(Area_rain^2) +
               # RealFatherAge +
               # I(RealFatherAge^2) +
               # CoupleExpLocal +
               frailty(NIDO),
             data = Datasurvival)

summary(Coxph)
ggsurv <- ggsurvplot(survfit(Coxph), data = Datasurvival, conf.int = T, palette = "Dark2", 
           censor = FALSE, legend.labs = c( 'Chick A from depredated nest', 'Chick A from no depredated nest')); ggsurv

predictions <- ggsurv$data.survplot

PlotCox_facilitation <- predictions %>% 
  ggplot(aes(time, surv, color = strata)) +
  geom_step(size = 1, alpha = 0.8, aes(linetype = strata)) +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = strata), alpha = 0.4) +
  scale_x_continuous(n.breaks = 20) +
  ylim(0, 1) +
  theme_survminer() +
  theme(legend.position = c(0.7, 0.3))+
  xlab('Age (days)') +
  ylab('Survival probability') +
  scale_colour_ghibli_d("LaputaMedium", direction = -1) +
  scale_fill_ghibli_d("LaputaMedium", direction = -1) +
  scale_linetype(labels = c("No", "Yes")) +
  guides(linetype = guide_legend(title = "Sibling presence"),
         fill = F, color = F); PlotCox_facilitation

ggsave(plot = PlotCox_facilitation, filename = "PlotCox_facilitation.png", dpi = 300)

```

### Results
```{r}
Smry <- summary(CoxmeWA); Smry

CI <- confint(CoxmeWA); CI

# Save results for mardown report
CoxmeCoef <- jstable:::coxmeTable(CoxmeWA) %>% cbind(CI) %>% bind_rows(Smry$vcoef %>% as.data.frame()) %>% rownames_to_column("Terms"); CoxmeCoef

write.csv(CoxmeCoef, "FinalResults.csv", row.names = FALSE)
```
```{r}
# check_collinearity(Coxme)
rms::vif(CoxmeWA)

```

# Run Cox Diagnostic
```{r}
# check_collinearity(Coxme)
rms::vif(Coxph)

zph <- cox.zph(Coxph) ; zph
ggcoxzph(zph)

aa_fit <-aareg(Surv(Start_time, Stop_time, Death601) ~ (SibPresence) +
               PROPORTIONALRANK +
               # SibPresence : Chl + # No Sign
               # SibPresence : SST +
               # SibPresence : PROPORTIONALRANK + # No Sign
               Chl +
               I(Chl^2) +
               SST + 
               I(SST^2) +
               Area_rain +
               I(Area_rain^2) +
               # RealFatherAge +
               # I(RealFatherAge^2) +
               # CoupleExpLocal +
               frailty(NIDO),
             data = Datasurvival)

# autoplot(aa_fit)


# Final Checking influential observations

# type = "dfbeta" , type = "deviance"


ggcoxdiagnostics(Coxph, type = "dfbeta",
                 linear.predictions = FALSE, ggtheme = theme_bw()) # Looks good 

ggcoxdiagnostics(Coxph, type = "deviance",
                 linear.predictions = FALSE, ggtheme = theme_bw()) # We see more negative values correspond to individual that "lived too long". Only problem with diagnostic

# Identify outliers
library(coxrobust)
res_mart = resid(Cox,type="martingale") %>% stack()# martingale or deviance
res_mart %>% #dplyr::slice_max(values, n = 100) %>%
  ggplot(aes(ind, values)) + geom_point()

# Final Checking non linearity

ggcoxfunctional(Surv(Start_time, Stop_time, Death601) ~ SibPresence +
               PROPORTIONALRANK +
               # SibPresence : Chl + # No Sign
               # SibPresence : SST +
               Chl +
               I(Chl^2) +
               SST + 
               I(SST^2) +
               Area_rain +
               I(Area_rain^2) + 
               # RealMotherAge +
               # I(RealMotherAge^2) +
               # CoupleExpLocal +
               frailty(NIDO),
             data = ClimCount_naomit)
  
  
  
```
Export Cox results
```{r}
BestCoxmeFin <- readRDS("Cox_Facilitation_Fin.rds")
BestCoxmeFem <- readRDS("Cox_Facilitation_Fem.rds")
BestCoxmeMal <- readRDS("Cox_Facilitation_Mal.rds")

summary(BestCoxmeFin)
summary(BestCoxmeFem)
SumSurvFacil <- summary(BestCoxmeMal)

SumSurvFacil$coefficients

CoxMal <- readRDS("Cox_Facilitation_Mal.rds") %>% jstable:::coxmeTable() %>% 
  mutate(HR = exp(beta), .after = "beta") %>%
  cbind(confint(readRDS(str_glue("Cox_Facilitation_Mal.rds"))))

write.csv(CoxMal, "Surv_Results.csv")
```


# Data for mass analisis

## Filter chicks of interest for mass analysis 
```{r}
RefMother <- RawMother %>% 
  filter(!SEMANIPULO == "t") %>% 
  filter(!Nest_OrderFemale %in% c(2,3)) %>% 
  filter(!(!is.na(CONLLEGADA) & Arrival_date > ESTECLOS1)) %>% # IDEM
  filter(!LastAge1 %in% c(-50 : 65)) # remove data where chicks were mesure before 70 days old
  
## Add environemental conditions for fledged chick A

ClimM <- read_csv(str_glue("C:/Users/{path}/Dropbox/PHD/Git/Climwin_MassA/RefittedDATABodyCond_1.csv"))
ClimM_A <- ClimM %>% select(ANILLO, WORKYEAR, NIDO, RefittedChl, RefittedSST, RefittedAreaRain)

ClimMother <- RefMother %>% left_join(ClimM_A, by = c("WORKYEAR", "NIDO"))

## Add variable sib presence 
False_Singleton <- ClimMother %>%
  filter(PUESTA == 2) %>%
  filter(DESTHUEVO1 %in% c("e")) %>% #Huevos depredados como cria aqui las dos crias eclosionaron
  filter((DESTHUEVO2 %in% c("e") & MURIO2 %in% c("t") & LastAge2 %in% c(0:5) & SENCONTRO2 %in% c("f")) | (DESTHUEVO2 %in% c("c"))) %>%
  mutate(SibPresence = "0") %>%
  mutate(Fledge = ifelse (MURIO1 == "f", 1, 0))
  
Siblings <- ClimMother %>% 
  filter(PUESTA == 2 & NIDADA == 2) %>% 
  filter(!FECHFINAL1 < ESTECLOS2) %>% # filter only nest with cohabitation (remove database error)
  filter(!(MURIO2 %in% c("t") & LastAge2 %in% c(0:5))) %>% 
  mutate(SibPresence = "1") %>% 
  mutate(Fledge = ifelse (MURIO1 == "f", 1, 0))
```





```{r}
Facilitation <- bind_rows(False_Singleton, Siblings) %>% 
  select(WORKYEAR, NIDO, PROPORTIONALRANK, 
         SibPresence, Fledge,
         # BodyCondSMI1, 
         PESO701, ULNA701,
         RefittedChl,
         RefittedSST,
         RefittedAreaRain,
         CoupleExpLocal,
         RealMotherAge, CONFIRMHEMB, ANILLOHEMB,
         # RealFatherAge,CONFIRMMACH,ANILLOMACH,
         ) %>%  
  filter(CONFIRMHEMB == "t" & !ANILLOHEMB == "SA") %>%
  # filter(CONFIRMMACH == "t" & !ANILLOMACH == "SA") %>%
  mutate(across(c(where(is.numeric), #-BodyCondSMI1, 
                  -PESO701, -Fledge, -WORKYEAR), arm::rescale)) %>% 
  mutate(across(c(where(is.character)), as.factor)) %>% 
  drop_na() %>% glimpse()

Facilitation %>% count(SibPresence)

# Remove outliers (Zero outliers)
outliers=boxplot(Facilitation$PESO701,range = 3)$out
DATABodyout=Facilitation[-which(Facilitation$PESO701 %in% outliers),]#Remove outliers
hist(DATABodyout$PESO701)
```

## Analysis mass LMER
```{r}
Facilitation %<>% mutate(SibPresence = fct_relevel(SibPresence, "0", after = 3L))
Facilitation %>% count(SibPresence)

Bestcond=lmer(PESO701 ~ SibPresence + PROPORTIONALRANK + # Interaction effect with SST and Chl
                ULNA701 +
                RefittedChl +
                I(RefittedChl^2) +
                RefittedSST +
                I(RefittedSST^2) +
                RefittedAreaRain +
                I(RefittedAreaRain^2) +
                # SibPresence:RefittedSST+
                SibPresence:RefittedChl+ 
                CoupleExpLocal +
                RealMotherAge +
                I(RealMotherAge^2) +
                # RealFatherAge +
                # I(RealFatherAge^2) +
                (1|WORKYEAR), #+ (1|ANILLOMACH),
              REML= FALSE, data = Facilitation)
sjPlot::tab_model(Bestcond)

Summary_M <- summary(Bestcond) 
CI_M <- confint(Bestcond) %>% as.data.frame() %>% rownames_to_column("Terms") %>% slice(-1, -2)
FixCoef_M <- Summary_M$coefficients %>% as.data.frame() %>% rownames_to_column("Terms")
RandCoef_M <- Summary_M$varcor %>% as.data.frame() %>% select(-var1, -var2) %>% rename(Terms = grp)
CoefTable_M <- CI_M %>% left_join(FixCoef_M, by = "Terms") %>% bind_rows(RandCoef_M)
write_csv(CoefTable_M, "Mass_Results_Fem_int.csv")


levels(Facilitation$SibPresence)
emmeans::lsmeans(Bestcond, pairwise ~ SibPresence, adjust = "tukey")
```

### Test random effect 
```{r}
BestcondNULL <- update(Bestcond, . ~ . -(1|ANILLOMACH)) #ANILLOMACH/ANILLOHEMB
bbmle::AICtab(BestcondNULL, Bestcond)
```



## Plot
```{r}
plot(allEffects(Bestcond))
plot(ggeffect(Bestcond,type = "response",c("RefittedSST","SibPresence")))
ef <- effect("SibPresence:RefittedSST", Bestcond)
x <- as.data.frame(ef)
summary(x)
ggplot(x, aes(fit, SibPresence, color = SibPresence)) + geom_line() +
  geom_smooth(aes(ymin=lower, ymax=fit+se, fill = SibPresence), stat = "identity", alpha = 0.3) +
  theme_fivethirtyeight() +
  theme(axis.title = element_text(),
        plot.caption = element_text(size = 15, hjust = 0),
        plot.background = element_rect(fill = "white"),
        panel.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white")) +
  scale_x_continuous(n.breaks = 10) +
  scale_y_continuous(n.breaks = 10) +
  scale_fill_manual(values =  c("#a60019" ,"#009dab")) +
  scale_color_manual(values = c("#a60019" ,"#009dab")) +
  labs(x = "Cohabitation Time", y = "Body Condition",
       caption = "Graph of the body condition in function of cohabitation time
when brood reduction occurred")

ggsave(filename = "C:/Users/ivan/Dropbox/PHD/Plots/rplot.png", width = 9, height = 6)
```



The only significatif term is proportional rank. 
Mother, couple experiance and layasyncrony does't have any effect
There is no significative interaction between PropRank/SST/Chl and SibPresence
There is no difference between singletons and siblings in body condition/weight at 70 days

### Check diagnostic
```{r}
#Check Vif
check_collinearity(Bestcond) # OK

## Attacin from Woestmann
## Linearity
plot(resid(Bestcond),fitted(Bestcond))
## Homogeneity
plot(Bestcond)
## Normality
qqnorm(residuals(Bestcond))
## Outlier
library(plotly)
ggplotly(plot(hatvalues(Bestcond)~residuals(Bestcond)))
```















# Long term data


# Data for mass analisis

## Filter chicks of interest for mass analysis 
```{r}
RefMother <- RawMother %>% 
  filter(!SEMANIPULO == "t") %>% 
  filter(!Nest_OrderFemale %in% c(2,3)) %>% 
  filter(!(!is.na(CONLLEGADA) & Arrival_date > ESTECLOS1)) 
  
## Add variable sib presence 
False_Singleton <- RefMother %>%
  filter(PUESTA == 2) %>%
  filter(DESTHUEVO1 %in% c("e")) %>% #Huevos depredados como cria aqui las dos crias eclosionaron
  filter((DESTHUEVO2 %in% c("e") & MURIO2 %in% c("t") & LastAge2 %in% c(0:5) & SENCONTRO2 %in% c("f")) | (DESTHUEVO2 %in% c("c"))) %>%
  mutate(SibPresence = "0") %>%
  mutate(Fledge = ifelse (MURIO1 == "f", 1, 0))
  
Siblings <- RefMother %>% 
  filter(PUESTA == 2 & NIDADA == 2) %>% 
  filter(!FECHFINAL1 < ESTECLOS2) %>% # filter only nest with cohabitation (remove database error)
  filter(!(MURIO2 %in% c("t") & LastAge2 %in% c(0:5))) %>% 
  mutate(SibPresence = "1") %>% 
  mutate(Fledge = ifelse (MURIO1 == "f", 1, 0))
```


```{r}
Facilitation <- bind_rows(False_Singleton, Siblings) %>% 
  filter(Fledge == 1) %>% 
  select(WORKYEAR, NIDO, PROPORTIONALRANK, ANILLO1,
         SibPresence) %>%  
  mutate(across(c(where(is.numeric), -WORKYEAR), arm::rescale)) %>% 
  mutate(across(c(where(is.character)), as.factor)) %>% 
  drop_na() %>% glimpse()

Facilitation %>% count(SibPresence)
```

## Import adult data and add it
```{r}
DATA_Adults <- read.csv("DATA_Adult.csv")

LongTerm_Facilitation <- Facilitation %>% left_join(., DATA_Adults, by = c("ANILLO1" = "IDAdult")) %>% 
   mutate(Sex = as.factor(Sex)) %>% 
  mutate(Clutchsum = if_else(is.na(Clutchsum), 0, as.numeric(Clutchsum))) %>% 
  mutate(Recruit = if_else(is.na(Sex), 0, 1)) %>% 
  mutate(PROPORTIONALRANK = arm::rescale(PROPORTIONALRANK))

LongTerm_Facilitation %>% drop_na() %>% count(SibPresence)    
  


```

## Check sample size and distributions
```{r}
LongTerm_Facil %>% names()
LongTerm_Facil %>% count(SibPresence)

hist(LongTerm_Facil$Fechpuestamean) # normal distribution
hist(LongTerm_Facil$Clutchsum) # trunquated poisson distribution
hist(LongTerm_Facil$Fledgesum) # poisson distribution
```
 

# Average laying timing during the first 6 years 
```{r}

LongTerm_Facil <- LongTerm_Facilitation %>% select(Fechpuestamean, SibPresence, PROPORTIONALRANK, Sex, WORKYEAR.x) %>% 
  drop_na()

Laying_date <- glmmTMB(Fechpuestamean ~ SibPresence +
                      PROPORTIONALRANK +
                      # RefittedChl + RefittedSST +
                      # RefittedChl : SibPresence +
                      # Sex : SibPresence +
                      Sex + 
                        # SibPresence:Sex +
                      (1|WORKYEAR.x),
                    family=beta_family(), REML = F,
                    data = LongTerm_Facil)

sjPlot::tab_model(Laying_date)
View(LongTerm_Facil)
Summary_L <- summary(Laying_date) 
CI_L <- confint(Laying_date) %>% as.data.frame() %>% rownames_to_column("Terms") %>% slice(-1, -2) 
FixCoef_L <- Summary_L$coefficients %>% as.data.frame() %>% rownames_to_column("Terms")
RandCoef_L <- Summary_L$varcor %>% as.data.frame() %>% select(-var1, -var2) %>% rename(Terms = grp)
CoefTable_L <- CI_L %>% left_join(FixCoef_L, by = "Terms") %>% bind_rows(RandCoef_L)
write_csv(CoefTable_L, "Laying_Results.csv")


check_collinearity(Laying_date) 
```


# Fledglings produced during the first 6 years (5 years?)

```{r}
LongTerm_Facil <- LongTerm_Facilitation %>% select(Fledgesum, SibPresence, PROPORTIONALRANK, Sex, WORKYEAR.x) %>% 
  drop_na()
LongTerm_Facil %>% count(SibPresence)

Fledg_produced <- glmmTMB(Fledgesum ~ SibPresence +
                          PROPORTIONALRANK +
                          # RefittedChl + RefittedSST +
                          Sex + 
                            # SibPresence: Sex +
                          (1|WORKYEAR.x),
                        family = poisson(link = "log"),
                        ziformula = ~0,
                        REML = F, 
                        data = LongTerm_Facil)

check_collinearity(Fledg_produced) 


Summary_F <- summary(Fledg_produced) 
CI_F <- confint(Fledg_produced) %>% as.data.frame() %>% rownames_to_column("Terms") %>% select(-Estimate) %>% 
  mutate(Terms = str_remove(Terms, "cond."), Terms = str_remove(Terms, ".Std.Dev.\\(Intercept\\)")) 
FixCoef_F <- Summary_F$coefficients$cond %>% as.data.frame() %>% rownames_to_column("Terms")
RandCoef_F <- Summary_F$varcor$cond %>% .[1] %>% as.data.frame() %>% rename(Variance  = X.Intercept.) %>% 
  mutate(Std.Dev. = sqrt(Variance)) %>% mutate(Terms = "WORKYEAR", .before = Variance)
CoefTable_F <- FixCoef_F %>% bind_rows(RandCoef_F) %>% left_join(CI_F, by = "Terms")
write_csv(CoefTable_F, "Fledglings_Results.csv")

```

# Recruits produced during the first 6 years 
```{r}
LongTerm_Facil <- LongTerm_Facilitation %>% select(N_recruits, SibPresence, PROPORTIONALRANK, Sex, WORKYEAR.x) %>% 
  filter(WORKYEAR.x < 2019-12) %>% 
  drop_na() %>% glimpse()

LongTerm_Facil %>% count(SibPresence)

hist(LongTerm_Facil$N_recruits)

Recru_produced <- glmmTMB(N_recruits ~ SibPresence +
                          PROPORTIONALRANK +
                          # RefittedChl + RefittedSST +
                          Sex + 
                            # Sex:SibPresence +
                          (1|WORKYEAR.x),
                        family = poisson(link = "log"),
                        # ziformula = ~0,
                        REML = F, 
                        data = LongTerm_Facil)


check_collinearity(Recru_produced) 


Summary_R <- summary(Recru_produced) 
CI_R <- confint(Recru_produced) %>% as.data.frame() %>% rownames_to_column("Terms") %>% select(-Estimate) %>% 
  mutate(Terms = str_remove(Terms, "cond."), Terms = str_remove(Terms, ".Std.Dev.\\(Intercept\\)")) 
FixCoef_R <- Summary_R$coefficients$cond %>% as.data.frame() %>% rownames_to_column("Terms")
RandCoef_R <- Summary_R$varcor$cond %>% .[1] %>% as.data.frame() %>% rename(Variance  = X.Intercept.) %>% 
  mutate(Std.Dev. = sqrt(Variance)) %>% mutate(Terms = "WORKYEAR", .before = Variance)
CoefTable_R <- FixCoef_R %>% bind_rows(RandCoef_R) %>% left_join(CI_R, by = "Terms")
write_csv(CoefTable_R, "Recruits_Results.csv")
```






# Recrutement probability 

# Data
```{r, eval=FALSE}
RefMother <- RawMother %>% 
  filter(!SEMANIPULO == "t") %>% 
  filter(!Nest_OrderFemale %in% c(2,3)) %>% 
  filter(!(!is.na(CONLLEGADA) & Arrival_date > ESTECLOS1)) %>% # IDEM
  filter(!LastAge1 %in% c(-50 : 65)) # remove data where chicks were mesure before 70 days old
  
## Add variable sib presence 
False_Singleton <- RefMother %>%
  filter(PUESTA == 2) %>%
  filter(DESTHUEVO1 %in% c("e")) %>% #Huevos depredados como cria aqui las dos crias eclosionaron
  filter((DESTHUEVO2 %in% c("e") & MURIO2 %in% c("t") & LastAge2 %in% c(0:5) & SENCONTRO2 %in% c("f")) | (DESTHUEVO2 %in% c("c"))) %>%
  mutate(SibPresence = "0") %>%
  mutate(Fledge = ifelse (MURIO1 == "f", 1, 0))
  
Siblings <- RefMother %>% 
  filter(PUESTA == 2 & NIDADA == 2) %>% 
  filter(!FECHFINAL1 < ESTECLOS2) %>% # filter only nest with cohabitation (remove database error)
  filter(!(MURIO2 %in% c("t") & LastAge2 %in% c(0:5))) %>% 
  mutate(SibPresence = "1") %>% 
  mutate(Fledge = ifelse (MURIO1 == "f", 1, 0))
```


```{r}
Facilitation <- bind_rows(False_Singleton, Siblings) %>% 
  filter(Fledge == 1) %>% 
  select(WORKYEAR, NIDO, PROPORTIONALRANK, ANILLO1,
         SibPresence, PESO701) 


Facilitation %>% count(SibPresence)

Recruitment <- read_csv("IDRecruitement.csv") %>% select(-X1)

DATA_Recr <- Facilitation %>% left_join(., Recruitment, by = c("ANILLO1" = "IDAdult")) %>% 
  dplyr::mutate(across(c(WORKYEAR, Sex), as.character)) %>% 
  dplyr::mutate(across(c(where(is.numeric), -Recruit, -FirstRepAge), arm::rescale)) %>%
  mutate(Recruit = if_else(is.na(Recruit), 0, Recruit)) %>% glimpse()
  
  
DATA_Recr %>% dplyr::count(SibPresence)
```




## Recruit probability
```{r, eval=FALSE}

DATA_Recr_Prob <- DATA_Recr %>% select(Recruit, SibPresence, PESO701, PROPORTIONALRANK, WORKYEAR) %>% drop_na()

Prob_recruit <- glmmTMB(Recruit ~  SibPresence + PESO701 + 
                       PROPORTIONALRANK + 
                       (1|WORKYEAR),
                     family = binomial(link="logit"), REML = FALSE, #ziformula = ~ 0,
                     data = DATA_Recr_Prob) #cloglog winer vs logit / z0 winner vs Z1


summary(Prob_recruit)

Summary_RP <- summary(Prob_recruit) 
CI_RP <- confint(Prob_recruit) %>% as.data.frame() %>% rownames_to_column("Terms") %>% select(-Estimate) %>% 
  mutate(Terms = str_remove(Terms, "cond."), Terms = str_remove(Terms, ".Std.Dev.\\(Intercept\\)")) 
FixCoef_RP <- Summary_RP$coefficients$cond %>% as.data.frame() %>% rownames_to_column("Terms")
RandCoef_RP <- Summary_RP$varcor$cond %>% .[1] %>% as.data.frame() %>% dplyr::rename(Variance = X.Intercept.) %>% 
  mutate(Std.Dev. = sqrt(Variance)) %>% dplyr::mutate(Terms = "WORKYEAR", .before = Variance)
CoefTable_RP <- FixCoef_RP %>% bind_rows(RandCoef_RP) %>% left_join(CI_RP, by = "Terms")
write_csv(CoefTable_RP, "RecruitsProba_Results.csv")

```
## Recruit age
```{r}
DATA_Recr_Age <- DATA_Recr %>% select(FirstRepAge, SibPresence, PESO701, PROPORTIONALRANK, WORKYEAR) %>% drop_na()

hist(DATA_Recr_Age$FirstRepAge)

Age_recruit <- lmer(FirstRepAge ~  SibPresence + PESO701 + 
                       PROPORTIONALRANK + 
                       (1|WORKYEAR), REML = FALSE, #ziformula = ~ 0,
                     data = DATA_Recr_Age) #cloglog winer vs logit / z0 winner vs Z1


summary(Prob_recruit)

```



```{r}
# Diagnostics
res = simulateResiduals(Recru_produced)
plot(res)
testDispersion(res)
testUniformity(res)
testOutliers(res)
testQuantiles(res)
testZeroInflation(res)


#Check Vif
check_collinearity(Age_recruit) # OK for all models
## Attacin from Woestmann
## Linearity
plot(resid(Age_recruit),fitted(Age_recruit))
## Homogeneity
plot(Age_recruit)
## Normality
qqnorm(residuals(Age_recruit))
```





### Plot GLMER
```{r, eval=FALSE}
plot(allEffects(Bestsurvival))
```
Proportional rank and SST have an effect on recruit probabilities. Interestingly it seems that SST has a stronger negatif effect on chicks A that shared the nest with a sibling than true singleton. Chl has no effect in recruitment.






























### Select singletons broods and brood reduced broods
```{r, eval=FALSE}
source(str_glue("C:/Users/{path}/Dropbox/PHD/Custom functions/Censoring.R"))
# source(str_glue("C:/Users/{path}/Dropbox/PHD/Custom functions/sum_na.R"))


RefMother <- Mother %>% 
  filter(SEMANIPULO == "f") %>% 
  # filter(is.na(CONLLEGADA)) %>% 
  filter(!(!is.na(CONLLEGADA) & Eclos_Arrival < 21)) %>% # only use nest where laying date was after first monitoring or at least 3 weeks before arrival
  filter(!Nest_OrderFemale %in% c(2,3)) %>%
  Censoring(., 60) %>% 
  # filter(!(MURIO2 %in% c("t") & LastAge2 %in% c(0:5) & SENCONTRO2 %in% c("f"))) %>% # remove depredation
  # filter(!(MURIO1 %in% c("t") & LastAge1 %in% c(0:5) & SENCONTRO1 %in% c("f"))) %>% 
  mutate(across(c(FECHFINAL1), ymd))
```

##### For Chick A
```{r, eval=FALSE}
Singleton <- RefMother %>%
  # filter(!WORKYEAR < 2003) %>% # In case that we want to study chl effect (if we thinks sibling facilitation changes in function of resources availability)
  filter(PUESTA == 1 & NIDADA == 1) %>% 
  mutate(SibPresence = "True_Singleton")

False_Singleton <- RefMother %>%
  # filter(!WORKYEAR < 2003) %>% # In case that we want to study chl effect (if we thinks sibling facilitation changes in function of resources availability)
  filter(PUESTA == 2 & NIDADA == 1) %>% 
  mutate(SibPresence = "False_Singleton")
  
Siblings <- RefMother %>% 
  # filter(!WORKYEAR < 2003) %>% 
  filter(PUESTA == 2 & NIDADA == 2) %>% 
  filter(!FECHFINAL1 < ESTECLOS2) %>% # filter only nest with cohabitation
  filter(xor(Death602 == 1, Death601 == 1)) %>% # keep only nest where B died or A died
  mutate(SibPresence = "Siblings") 

Triblings <- RefMother %>%
  # filter(!WORKYEAR < 2003) %>%
  filter(PUESTA == 3 & NIDADA == 3) %>%
  filter(FECHFINAL1 > ESTECLOS3) %>% # filter only nest with cohabitation
  # filter(Death602 == 1 & Death603 == 1) %>% # keep only nest where B and C died
  mutate(SibPresence = "Triblings") # Chick A from reduced clutch/brood of 3

TriblingsA <- RefMother %>%
  # filter(!WORKYEAR < 2003) %>%
  filter(PUESTA == 3 & NIDADA == 1) %>%
  filter(DESTHUEVO1 == "e") %>% # filter only nest with cohabitation
  mutate(SibPresence = "TriblingsA") # Chick A from clutch of 3 (only A hatched)


Facilitation <- bind_rows(Singleton, False_Singleton, 
                          Triblings, TriblingsA,
                          Siblings) 

DataCountingProcess = Facilitation %>% 
  filter(across(c(Death601, Time601), ~ !is.na(.))) %>% 
  mutate(across(c(Death601), as.character)) %>% 
  # Step needed for greg package
  timeSplitter(by = 3, 
               event_var = "Death601",
               time_var = "Time601",
               event_start_SibPresence = "0") %>% 
  mutate(Death = factor(Death601,
                        levels = 0:1,
                        labels = c("Alive", "Death"))) %>% 
  mutate(across(c(Death601), as.character)) %>% 
  mutate(across(c(Death601), as.numeric)) 

```

#### For chick B
```{r, eval=FALSE}
Triblings_ForB <- RefMother %>%
  # filter(!WORKYEAR < 2003) %>%
  filter(PUESTA == 3 & NIDADA == 3) %>%
  filter(FECHFINAL2 > ESTECLOS3) %>% # filter only nest with cohabitation
  filter(Death601 == 0 & Death603 == 1) %>% # keep only nest where B and C died
  mutate(SibPresence = "Triblings") # Chick B from reduced clutch/brood of 3

TriblingsB_ForB <- RefMother %>%
  # filter(!WORKYEAR < 2003) %>%
  filter(PUESTA == 3 & NIDADA == 2) %>%
  filter(Death601 == 0 & DESTHUEVO3 != "e") %>% # filter only nest with cohabitation
  mutate(SibPresence = "TriblingsB") # Chick B from clutch of 3 (C didn't hatch)

SiblingsB <- RefMother %>% 
  # filter(!WORKYEAR < 2003) %>% 
  filter(PUESTA == 2 & NIDADA == 2) %>% 
  filter(Death601 == 0) %>% # keep only nest where B died
  mutate(SibPresence = "SiblingsB") 


FacilitationB <- bind_rows(Triblings_ForB, TriblingsB_ForB, 
                          SiblingsB)

DataCountingProcessB = FacilitationB %>% 
  filter(across(c(Death602, Time602), ~ !is.na(.))) %>% 
  mutate(across(c(Death602), as.character)) %>% 
  # Step needed for greg package
  timeSplitter(by = 3, 
               event_var = "Death602",
               time_var = "Time602",
               event_start_SibPresence = "0") %>% 
  mutate(Death = factor(Death602,
                        levels = 0:1,
                        labels = c("Alive", "Death"))) %>% 
  mutate(across(c(Death602), as.character)) %>% 
  mutate(across(c(Death602), as.numeric)) 

```
#### For Chick A
# Cox Model
```{r, eval=FALSE}
CoxData <- DataCountingProcess %>% select(Start_time, Stop_time, Death601, SibPresence, PROPORTIONALRANK, RealMotherAge,
                                          CoupleExpLocal, WORKYEAR) %>% 
  mutate(across(c(PROPORTIONALRANK, RealMotherAge, CoupleExpLocal), arm::rescale)) %>% 
  mutate(across(c(SibPresence), as.factor)) %>% #filter(!SibPresence %in% c("Siblings", "False_Singleton", "True_Singleton")) %>%
  glimpse() 
Cox <- coxph(Surv(Start_time, Stop_time, Death601) ~ strata(SibPresence) +
               PROPORTIONALRANK +
               RealMotherAge +
               I(RealMotherAge^2) +
               CoupleExpLocal + 
               frailty(WORKYEAR),
             data = CoxData)

summary(Cox)
```
## Cox plot

```{r, eval=FALSE}
ggsurv <- ggsurvplot(survfit(Cox), data = CoxData, conf.int = T, palette = "Dark2", 
           censor = FALSE) #, legend.labs = c('Chick A from reduced clutch/brood of 3', 'Chick A from clutch of 3 (only A hatched)'))

predictions <- ggsurv$data.survplot

predictions %>% 
  filter(!strata %in% c("Triblings", "TriblingsA")) %>%
  # filter(!strata %in% c("Siblings", "False_Singleton", "True_Singleton")) %>%
  ggplot(aes(time, surv, color = strata)) +
  geom_step(size = 0.5, alpha = 0.8) +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = strata), alpha = 0.4) +
  theme_survminer() +
  theme(legend.position = c(0.6, 0.8))+
  xlab('Age (days)') +
  ylab('Survival probability') +
  scale_colour_ghibli_d("LaputaMedium", direction = -1) +
  scale_fill_ghibli_d("LaputaMedium", direction = -1, labels = c("Chick A from clutch of 2 (only A hatched)",
                                                                 "Chick A from reduced clutch/brood of 2",
                                                                 "Chick A from clutch of 1")) +
  # scale_colour_ghibli_d("MononokeMedium", direction = 1) +
  # scale_fill_ghibli_d("MononokeMedium", direction = 1, labels = c("Chick A from clutch of 3",
  #                                                                 "Chick A from reduced clutch/brood of 3")) +
  guides(color = F, fill = guide_legend(title = "SibPresence"))

```
#### For Chick B
# Cox Model
```{r, eval=FALSE}
CoxData <- DataCountingProcessB %>% select(Start_time, Stop_time, Death602, SibPresence, PROPORTIONALRANK, RealMotherAge,
                                          CoupleExpLocal, WORKYEAR) %>% 
  mutate(across(c(PROPORTIONALRANK, RealMotherAge, CoupleExpLocal), arm::rescale)) %>% 
  mutate(across(c(SibPresence), as.factor)) %>% #filter(!SibPresence %in% c("Siblings", "False_Singleton", "True_Singleton")) %>%
  glimpse() 

Cox <- coxph(Surv(Start_time, Stop_time, Death602) ~ strata(SibPresence) +
               PROPORTIONALRANK +
               RealMotherAge +
               I(RealMotherAge^2) +
               CoupleExpLocal + 
               frailty(WORKYEAR),
             data = CoxData)

summary(Cox)
```
## Cox plot
```{r, eval=FALSE}
ggsurv <- ggsurvplot(survfit(Cox), data = CoxData, conf.int = T, palette = "Dark2", 
           censor = FALSE) #, legend.labs = c('Chick A from reduced clutch/brood of 3', 'Chick A from clutch of 3 (only A hatched)'))

predictions <- ggsurv$data.survplot

predictions %>% 
  ggplot(aes(time, surv, color = strata)) +
  geom_step(size = 0.5, alpha = 0.8) +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = strata), alpha = 0.4) +
  scale_x_continuous(n.breaks = 60) +
  theme_survminer() +
  theme(legend.position = c(0.6, 0.8))+
  xlab('Age (days)') +
  ylab('Survival probability') +
  scale_colour_ghibli_d("LaputaMedium", direction = -1) +
  scale_fill_ghibli_d("LaputaMedium", direction = -1, labels = c("Chick A from depredated nest",
                                                                 "Chick A from no depredated nest")) +
  guides(color = F, fill = guide_legend(title = "SibPresence"))
```


```{r, eval=FALSE}
New_data <- expand.grid(SibPresence = c("True_Singleton", "Siblings"), PROPORTIONALRANK = mean(CoxData$PROPORTIONALRANK, na.rm = T),
                        RealMotherAge = mean(CoxData$RealMotherAge, na.rm = T), 
                        CoupleExpLocal = mean(CoxData$CoupleExpLocal, na.rm = T),
                        Start_time = 1:60)
prs = predict(Cox, New_data,
              type = c("risk"), se.fit = T)
NDpred = New_data %>% mutate(pred = prs$fit) #%>% group_by(SibPresence, Start_time) %>% summarise(mean_pred = mean(pred, na.rm = T))
NDpred %>%
  # filter(ClimWSST == median(ClimWSST)) %>%
  # filter(HatchAsync == median(HatchAsync)) %>%
  # filter(PROPORTIONALRANK == median(PROPORTIONALRANK)) %>%
  # filter(WORKYEAR == 2017) %>%
  # arrange(ClimWRain_2) %>%
  ggplot(aes(Start_time ,pred), color = "SibPresence") + geom_point() #+ geom_smooth(method = "lm", formula = y ~ x, size = 1) +
  # geom_smooth(stat = "identity", aes(ymin = lo, ymax = up)) +
  # scale_x_continuous(n.breaks = 20, limits = c(22,28)) +
  # scale_y_continuous(labels = scales::comma, n.breaks = 20, limits = c(0.1,10)) +
  geom_hline(yintercept = 1, size = 1.1, color = "red", linetype = "dashed") +
  geom_vline(xintercept = 24.5, size = 0.5, color = "red", linetype = "dashed") +
  labs(y = "Hazard Ratio") +
  theme_fivethirtyeight() + theme(axis.title = element_text())
```


### Diagnostic
```{r, eval=FALSE}
# check_collinearity(Coxme)
rms::vif(Cox)
zph <- cox.zph(Cox) ; zph
ggcoxzph(zph) # For ploting

aa_fit <-aareg(Surv(Start_time, Stop_time, Death601) ~ SibPresence +
               PROPORTIONALRANK +
               RealMotherAge +
               CoupleExpLocal + 
               frailty(WORKYEAR),
             data = CoxData)

plot(aa_fit)

# autoplot(aa_fit)
```
```{r, eval=FALSE}
# Final Checking influential observations 

# type = "dfbeta" , type = "deviance"

ggcoxdiagnostics(Cox, type = , linear.predictions = TRUE)

ggcoxdiagnostics(Cox, type = "dfbeta",
                 linear.predictions = FALSE, ggtheme = theme_bw())

ggcoxdiagnostics(Cox, type = "deviance",
                 linear.predictions = FALSE, ggtheme = theme_bw()) # We see more negative values correspond to individual that "lived too long". Only problem with diagnostic

# Identify outliers 
library(coxrobust)
res_mart = resid(Cox,type="martingale") %>% stack()# martingale or deviance
res_mart %>% #dplyr::slice_max(values, n = 100) %>% 
  ggplot(aes(ind, values)) + geom_point()
```




# Eggs produced during the first 6 years 

```{r}
LongTerm_Facil <- LongTerm_Facilitation %>% select(Clutchsum, SibPresence, PROPORTIONALRANK, Sex, WORKYEAR.x) %>% 
  drop_na()

Egg_produced <- glmmTMB(Clutchsum ~ SibPresence +
                          PROPORTIONALRANK +
                          # RefittedChl + RefittedSST +
                          Sex + 
                          (1|WORKYEAR.x),
                        # family = "truncated_poisson"(link = "log"),
                        family = "poisson"(link = "log"),
                        REML = F, 
                        data = LongTerm_Facil)

check_collinearity(Egg_produced) 

Summary_E <- summary(Egg_produced) 
CI_E <- confint(Egg_produced) %>% as.data.frame() %>% rownames_to_column("Terms") %>% select(-Estimate) %>% 
  mutate(Terms = str_remove(Terms, "cond."), Terms = str_remove(Terms, ".Std.Dev.\\(Intercept\\)")) 
FixCoef_E <- Summary_E$coefficients$cond %>% as.data.frame() %>% rownames_to_column("Terms")
RandCoef_E <- Summary_E$varcor$cond %>% .[1] %>% as.data.frame() %>% rename(Variance  = X.Intercept.) %>% 
  mutate(Std.Dev. = sqrt(Variance)) %>% mutate(Terms = "WORKYEAR", .before = Variance)
CoefTable_E <- FixCoef_E %>% bind_rows(RandCoef_E) %>% left_join(CI_E, by = "Terms")
write_csv(CoefTable_E, "Eggs_Results.csv")
```